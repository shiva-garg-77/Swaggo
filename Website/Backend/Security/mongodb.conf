# ðŸ”’ MongoDB Security-Hardened Configuration
# Swaggo Production MongoDB Configuration

# Storage configuration
storage:
  dbPath: /data/db
  journal:
    enabled: true
    commitIntervalMs: 100
  directoryPerDB: true
  syncPeriodSecs: 60
  engine: wiredTiger
  wiredTiger:
    engineConfig:
      cacheSizeGB: 0.25  # Limit cache size for security
      journalCompressor: snappy
      directoryForIndexes: true
    collectionConfig:
      blockCompressor: snappy
    indexConfig:
      prefixCompression: true

# System log configuration  
systemLog:
  destination: file
  logAppend: true
  logRotate: reopen
  path: /data/db/mongodb.log
  component:
    accessControl:
      verbosity: 2
    command:
      verbosity: 1
    control:
      verbosity: 1
    ftdc:
      verbosity: 1
    geo:
      verbosity: 1
    index:
      verbosity: 1
    network:
      verbosity: 1
    query:
      verbosity: 1
    replication:
      verbosity: 1
    sharding:
      verbosity: 1
    storage:
      verbosity: 1
      journal:
        verbosity: 1
    write:
      verbosity: 1

# Network configuration
net:
  port: 27017
  bindIp: 0.0.0.0
  maxIncomingConnections: 100
  wireObjectCheck: true
  ipv6: false
  unixDomainSocket:
    enabled: false
  # TLS Configuration
  tls:
    mode: requireTLS
    certificateKeyFile: /etc/ssl/mongodb.pem
    CAFile: /etc/ssl/mongodb-ca.crt
    allowConnectionsWithoutCertificates: false
    allowInvalidHostnames: false
    allowInvalidCertificates: false
    disabledProtocols: TLS1_0,TLS1_1

# Process management
processManagement:
  fork: false
  timeZoneInfo: /usr/share/zoneinfo

# Security configuration
security:
  authorization: enabled
  clusterAuthMode: x509
  javascriptEnabled: false  # Disable server-side JavaScript for security
  redactClientLogData: true
  # Authentication mechanisms
  sasl:
    mechanisms: SCRAM-SHA-256
  # Enable audit logging
  auditLog:
    destination: file
    format: JSON
    path: /data/db/audit.log
    filter: '{ 
      atype: { 
        $in: [ 
          "authenticate", "authCheck", "createUser", "dropUser", 
          "createRole", "dropRole", "grantRolesToUser", "revokeRolesFromUser",
          "createCollection", "dropCollection", "createDatabase", "dropDatabase",
          "insert", "update", "delete", "createIndex", "dropIndex"
        ] 
      } 
    }'

# Operation profiling for security monitoring
operationProfiling:
  mode: slowOp
  slowOpThresholdMs: 100
  slowOpSampleRate: 1.0

# Set parameter for additional security
setParameter:
  authenticationMechanisms: SCRAM-SHA-256
  # Disable HTTP interface
  enableLocalhostAuthBypass: false
  # Connection limits
  maxConns: 200
  # Query timeout
  internalQueryExecMaxBlockingSortBytes: 33554432
  # Memory limits
  wiredTigerConcurrentReadTransactions: 64
  wiredTigerConcurrentWriteTransactions: 64
  # Security parameters
  scramIterationCount: 15000
  authFailedDelay: 5000
  # Cluster security
  clusterAuthMode: x509
  # Disable potentially dangerous operations
  notablescan: true
  # Enable collection and index statistics collection
  diagnosticDataCollectionEnabled: true