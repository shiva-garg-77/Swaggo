# ðŸ”’ Redis Security-Hardened Configuration
# Swaggo Production Redis Configuration

# ==== NETWORK & BIND ====
# Bind to all interfaces but use authentication
bind 0.0.0.0
protected-mode yes
port 6379

# Disable IPv6 for security
bind 127.0.0.1 ::1

# ==== AUTHENTICATION ====
# Require password authentication (set via environment variable)
# requirepass will be set via command line with REDIS_PASSWORD

# ==== SECURITY SETTINGS ====
# Disable dangerous commands
rename-command FLUSHDB ""
rename-command FLUSHALL ""
rename-command KEYS ""
rename-command CONFIG "CONFIG_b835c3f3a7d2a6c7"
rename-command DEBUG "DEBUG_b835c3f3a7d2a6c7"
rename-command EVAL "EVAL_b835c3f3a7d2a6c7"
rename-command SCRIPT "SCRIPT_b835c3f3a7d2a6c7"
rename-command SHUTDOWN "SHUTDOWN_b835c3f3a7d2a6c7"

# Disable potentially dangerous commands completely
rename-command DEL ""

# ==== MEMORY MANAGEMENT ====
# Set maximum memory usage (will be overridden by docker command)
maxmemory 256mb
maxmemory-policy allkeys-lru

# Memory sampling for LRU
maxmemory-samples 10

# ==== PERSISTENCE ====
# Enable AOF (Append Only File) for durability
appendonly yes
appendfilename "appendonly.aof"
appendfsync everysec
no-appendfsync-on-rewrite no
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb
aof-load-truncated yes
aof-use-rdb-preamble yes

# RDB settings (less critical with AOF enabled)
save 900 1
save 300 10
save 60 10000
rdbcompression yes
rdbchecksum yes
dbfilename dump.rdb

# ==== LOGGING ====
loglevel notice
logfile "/data/redis.log"
syslog-enabled no

# ==== CLIENT MANAGEMENT ====
# Connection limits
maxclients 1000
tcp-keepalive 300
timeout 300

# TCP backlog
tcp-backlog 511

# ==== SLOW LOG ====
# Log slow queries for performance monitoring
slowlog-log-slower-than 10000
slowlog-max-len 128

# ==== LATENCY MONITORING ====
latency-monitor-threshold 100

# ==== ADVANCED CONFIG ====
# Hash settings for memory optimization
hash-max-ziplist-entries 512
hash-max-ziplist-value 64

# List settings
list-max-ziplist-size -2
list-compress-depth 0

# Set settings
set-max-intset-entries 512

# Sorted set settings
zset-max-ziplist-entries 128
zset-max-ziplist-value 64

# HyperLogLog settings
hll-sparse-max-bytes 3000

# Stream settings
stream-node-max-bytes 4096
stream-node-max-entries 100

# ==== SECURITY ENHANCEMENTS ====
# Disable Lua debugging for security
lua-replicate-commands yes

# Set user access controls
# Default user (will be disabled in production)
user default off

# Create application user (password set via environment)
# This will be configured via command line

# ==== PERFORMANCE TUNING ====
# Disable transparent huge pages warning
# This should be handled at the OS level

# IO threads for better performance
io-threads 2
io-threads-do-reads yes

# ==== REPLICATION SETTINGS ====
# These would be uncommented for replica setup
# repl-diskless-sync no
# repl-diskless-sync-delay 5

# ==== CLUSTER SETTINGS ====
# Disabled for standalone instance
# cluster-enabled no

# ==== MODULES ====
# No modules loaded for security

# ==== NOTIFICATIONS ====
# Disable keyspace notifications for performance
notify-keyspace-events ""

# ==== CLIENT OUTPUT BUFFER LIMITS ====
client-output-buffer-limit normal 0 0 0
client-output-buffer-limit replica 256mb 64mb 60
client-output-buffer-limit pubsub 32mb 8mb 60

# ==== ADVANCED SECURITY ====
# ACL (Access Control List) settings for Redis 6+
aclfile /data/users.acl

# ==== GENERAL ====
# Set the database directory
dir /data

# Process ID file
pidfile /data/redis.pid

# Daemonize (disabled for Docker)
daemonize no

# Supervised by systemd/upstart
supervised no

# ==== MISCELLANEOUS ====
# Always show logo
always-show-logo no

# Set server verbosity to 'notice'
# 'debug', 'verbose', 'notice', 'warning'
loglevel notice

# ==== SECURITY HARDENING ====
# Disable protected mode if password is set (handled via password)
# protected-mode yes

# Increase minimum TLS version (if TLS is enabled)
# tls-protocols TLSv1.2 TLSv1.3

# ==== MEMORY SECURITY ====
# Clear memory on exit
# This helps prevent memory dumps from containing sensitive data

# ==== PERFORMANCE MONITORING ====
# Enable latency monitoring
latency-monitor-threshold 100

# Track memory usage
tracking-table-max-keys 1000000