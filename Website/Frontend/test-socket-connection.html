<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Socket.IO Connection Test</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        body {
            font-family: 'Courier New', monospace;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #1a1a1a;
            color: #00ff00;
        }
        h1 {
            color: #00ff00;
            text-align: center;
        }
        .status {
            padding: 20px;
            margin: 20px 0;
            border: 2px solid #00ff00;
            border-radius: 5px;
            background: #0a0a0a;
        }
        .connected {
            border-color: #00ff00;
            background: #001100;
        }
        .disconnected {
            border-color: #ff0000;
            color: #ff0000;
            background: #110000;
        }
        .connecting {
            border-color: #ffaa00;
            color: #ffaa00;
            background: #111100;
        }
        .log {
            background: #0a0a0a;
            border: 1px solid #333;
            padding: 15px;
            margin: 20px 0;
            max-height: 400px;
            overflow-y: auto;
            font-size: 12px;
        }
        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-left: 3px solid #00ff00;
            padding-left: 10px;
        }
        .log-error {
            border-left-color: #ff0000;
            color: #ff0000;
        }
        .log-warn {
            border-left-color: #ffaa00;
            color: #ffaa00;
        }
        .log-success {
            border-left-color: #00ff00;
            color: #00ff00;
        }
        button {
            background: #00ff00;
            color: #000;
            border: none;
            padding: 10px 20px;
            margin: 10px 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
        }
        button:hover {
            background: #00cc00;
        }
        button:disabled {
            background: #666;
            cursor: not-allowed;
        }
        .info-box {
            background: #0a0a0a;
            border: 1px solid #00ff00;
            padding: 15px;
            margin: 20px 0;
        }
        .info-item {
            margin: 8px 0;
        }
        .info-label {
            color: #00ff00;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>üîå Socket.IO Connection Diagnostic Tool</h1>
    
    <div id="statusBox" class="status disconnected">
        <strong>Status:</strong> <span id="statusText">Disconnected</span><br>
        <strong>Socket ID:</strong> <span id="socketId">N/A</span><br>
        <strong>Transport:</strong> <span id="transport">N/A</span>
    </div>

    <div class="info-box">
        <div class="info-item">
            <span class="info-label">Backend URL:</span> <span id="backendUrl">http://localhost:45799</span>
        </div>
        <div class="info-item">
            <span class="info-label">Test Mode:</span> <span>Direct Connection (No Auth Required)</span>
        </div>
    </div>

    <div>
        <button onclick="connectSocket()">Connect</button>
        <button onclick="disconnectSocket()">Disconnect</button>
        <button onclick="testHealthEndpoint()">Test Health Endpoint</button>
        <button onclick="clearLogs()">Clear Logs</button>
    </div>

    <div class="log" id="logContainer">
        <div class="log-entry">Diagnostic tool ready. Click "Connect" to test socket connection...</div>
    </div>

    <script>
        let socket = null;
        const BACKEND_URL = 'http://localhost:45799';
        
        function addLog(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            const timestamp = new Date().toLocaleTimeString();
            entry.textContent = `[${timestamp}] ${message}`;
            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function updateStatus(status, socketId = 'N/A', transport = 'N/A') {
            const statusBox = document.getElementById('statusBox');
            const statusText = document.getElementById('statusText');
            const socketIdEl = document.getElementById('socketId');
            const transportEl = document.getElementById('transport');

            statusText.textContent = status;
            socketIdEl.textContent = socketId;
            transportEl.textContent = transport;

            statusBox.className = 'status';
            if (status.includes('Connected')) {
                statusBox.classList.add('connected');
            } else if (status.includes('Connecting') || status.includes('Reconnecting')) {
                statusBox.classList.add('connecting');
            } else {
                statusBox.classList.add('disconnected');
            }
        }

        function connectSocket() {
            if (socket && socket.connected) {
                addLog('Socket already connected', 'warn');
                return;
            }

            addLog('üîå Attempting to connect to ' + BACKEND_URL, 'info');
            updateStatus('Connecting...');

            try {
                socket = io(BACKEND_URL, {
                    withCredentials: true,
                    transports: ['polling', 'websocket'],
                    reconnection: false,
                    forceNew: true,
                    timeout: 15000
                });

                // Connection successful
                socket.on('connect', () => {
                    addLog('‚úÖ Connected successfully!', 'success');
                    addLog(`Socket ID: ${socket.id}`, 'success');
                    addLog(`Transport: ${socket.io.engine.transport.name}`, 'success');
                    updateStatus('Connected', socket.id, socket.io.engine.transport.name);
                });

                // Authentication successful
                socket.on('authenticated', (data) => {
                    addLog('‚úÖ Authentication successful', 'success');
                    addLog(`User data: ${JSON.stringify(data)}`, 'success');
                });

                // Connection error
                socket.on('connect_error', (error) => {
                    addLog(`‚ùå Connection error: ${error.message}`, 'error');
                    addLog(`Error type: ${error.type || 'Unknown'}`, 'error');
                    addLog(`Error description: ${error.description || 'N/A'}`, 'error');
                    updateStatus('Connection Failed');
                });

                // Disconnection
                socket.on('disconnect', (reason) => {
                    addLog(`‚ö†Ô∏è Disconnected: ${reason}`, 'warn');
                    updateStatus('Disconnected');
                });

                // Transport upgrade
                socket.io.engine.on('upgrade', (transport) => {
                    addLog(`‚¨ÜÔ∏è Transport upgraded to: ${transport.name}`, 'info');
                    updateStatus('Connected', socket.id, transport.name);
                });

                // Error event
                socket.on('error', (error) => {
                    addLog(`‚ùå Socket error: ${error}`, 'error');
                });

            } catch (error) {
                addLog(`‚ùå Exception during connection: ${error.message}`, 'error');
                updateStatus('Connection Failed');
            }
        }

        function disconnectSocket() {
            if (socket) {
                addLog('Disconnecting socket...', 'info');
                socket.disconnect();
                socket = null;
                updateStatus('Disconnected');
            } else {
                addLog('No active socket to disconnect', 'warn');
            }
        }

        async function testHealthEndpoint() {
            addLog('Testing health endpoint...', 'info');
            try {
                const response = await fetch(`${BACKEND_URL}/health`);
                const data = await response.json();
                addLog(`‚úÖ Health check passed: ${JSON.stringify(data)}`, 'success');
            } catch (error) {
                addLog(`‚ùå Health check failed: ${error.message}`, 'error');
            }
        }

        function clearLogs() {
            document.getElementById('logContainer').innerHTML = '<div class="log-entry">Logs cleared.</div>';
        }

        // Display backend URL
        document.getElementById('backendUrl').textContent = BACKEND_URL;
        addLog(`Diagnostic tool loaded. Backend URL: ${BACKEND_URL}`, 'info');
    </script>
</body>
</html>
